
@model IEnumerable<WebApplication17.Models.GioHang>
@{
    ViewBag.Title = "Thanh Toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
    decimal TienHang = 0;
    decimal PhiVanChuyen = 0;
    var kh = ViewBag.taikhoan as WebApplication17.Models.KhachHang;
}

<main class="main">
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="~/Home/Index">Trang Chủ</a></li>
                <li class="breadcrumb-item"><a href="~/SanPhams">Sản Phẩm</a></li>
                <li class="breadcrumb-item active" aria-current="page">Thanh Toán</li>
            </ol>
        </div>
    </nav>

    <div class="page-content">
        <div class="checkout">
            <div class="container">
                <form action="/GioHangs/DatHang" method="post" id="formThanhToan">
                    <div class="row">
                        <div class="col-lg-7">
                            <h2 class="checkout-title">Chi Tiết Thanh Toán</h2>
                            <label>Họ Tên *</label>
                            <input type="text" class="form-control" name="hoten" value="@kh.hoten" required>

                            <label>Email *</label>
                            <input type="email" class="form-control" name="email" value="@kh.email" required>

                            <div class="row">
                                <div class="col-sm-6">
                                    <label>Tỉnh / Thành Phố *</label>
                                    <select class="form-control" id="tinh" name="tinh" data-selected="@kh.tinh" required>
                                        <option value="">--Chọn Tỉnh/TP--</option>
                                    </select>
                                </div>
                                <div class="col-sm-6">
                                    <label>Quận / Huyện *</label>
                                    <select class="form-control" id="huyen" name="huyen" data-selected="@kh.huyen" required>
                                        <option value="">--Chọn Quận/Huyện--</option>
                                    </select>
                                </div>

                            </div>

                            <div class="row">
                                <div class="col-sm-6">
                                    <label>Phường / Xã *</label>
                                    <select class="form-control" id="xa" name="phuongxa" data-selected="@kh.xa" required>
                                        <option value="">--Chọn Phường/Xã--</option>
                                    </select>
                                </div>
                                <div class="col-sm-6">
                                    <label>Điện Thoại *</label>
                                    <input type="tel" class="form-control" name="dienthoai" value="@kh.dienthoai" required>
                                </div>
                            </div>

                            <label>Địa Chỉ Cụ Thể</label>
                            <input type="text" class="form-control" name="diachi" value="@kh.diachi" required>
                        </div>

                        <aside class="col-lg-5">
                            <div class="summary">
                                <h3 class="summary-title">Sản Phẩm Mua</h3>
                                <table class="table table-summary">
                                    <thead>
                                        <tr>
                                            <th>Tên Sản Phẩm</th>
                                            <th>Số Lượng</th>
                                            <th>Giá Bán</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model != null && Model.Any())
                                        {
                                            foreach (var item in Model.Where(x => x.giaban != null && x.giaban > 0))
                                            {
                                                decimal gia = (item.giaban ?? 0);
                                                TienHang += gia;
                                                <tr>
                                                    <td>@item.SanPham.tensp (@item.CauHinhThem)</td>
                                                    <td>@item.soluong</td>
                                                    <td>@gia.ToString("N0")</td>
                                                </tr>
                                            }
                                        }
                                        <tr>
                                            <td><b>Phí Vận Chuyển:</b></td>
                                            <td id="phiVanChuyen">@PhiVanChuyen.ToString("N0")</td>
                                        </tr>
                                        <tr class="summary-total">
                                            <td>Tổng:</td>
                                            <td id="tongTien">@((TienHang + PhiVanChuyen).ToString("N0"))</td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div class="accordion-summary" id="accordion-payment">
                                    <div class="card">
                                        <div class="card-header">
                                            <input type="radio" name="thanhtoan" value="cod" checked> Thanh Toán Khi Nhận Hàng <br>
                                            <input type="radio" name="thanhtoan" value="banking"> Thanh Toán Chuyển Khoản (VNPay)
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btndathang">
                                    <span class="btn-text">ĐẶT HÀNG</span>
                                </button>
                            </div>
                        </aside>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<script src="~/Scripts/jquery-3.7.0.min.js"></script>
<script>
$(document).ready(function () {
    var selectedTinh = $("#tinh").data("selected");
    var selectedHuyen = $("#huyen").data("selected");
    var selectedXa = $("#xa").data("selected");

    // Load tỉnh
    $.get("https://provinces.open-api.vn/api/p/", function (data) {
        var tinhSelect = $("#tinh");
        tinhSelect.empty().append('<option value="">--Chọn Tỉnh/TP--</option>');
        data.forEach(function (item) {
            var selected = (item.name === selectedTinh) ? "selected" : "";
            tinhSelect.append('<option value="' + item.name + '" data-code="' + item.code + '" ' + selected + '>' + item.name + '</option>');
        });

        // Nếu có sẵn tỉnh -> load huyện
        if (selectedTinh) {
            var tinhCode = $("#tinh option:selected").data("code");
            loadHuyen(tinhCode, true); // true nghĩa là tự động tính phí sau khi load huyện
        }
    });

    // Khi chọn tỉnh -> load huyện
    $("#tinh").change(function () {
        var tinhCode = $("#tinh option:selected").data("code");
        $("#huyen").empty().append('<option value="">--Chọn Quận/Huyện--</option>');
        $("#xa").empty().append('<option value="">--Chọn Phường/Xã--</option>');
        if (tinhCode) {
            loadHuyen(tinhCode, false);
        }
        updatePhiVanChuyen();
    });

    // Khi chọn huyện -> load xã
    $("#huyen").change(function () {
        var huyenCode = $("#huyen option:selected").data("code");
        $("#xa").empty().append('<option value="">--Chọn Phường/Xã--</option>');
        if (huyenCode) {
            loadXa(huyenCode);
        }
        updatePhiVanChuyen();
    });

    function loadHuyen(tinhCode, autoTinhPhi) {
        $.get("https://provinces.open-api.vn/api/p/" + tinhCode + "?depth=2", function (data) {
            data.districts.forEach(function (h) {
                var selected = (h.name === selectedHuyen) ? "selected" : "";
                $("#huyen").append('<option value="' + h.name + '" data-code="' + h.code + '" ' + selected + '>' + h.name + '</option>');
            });

            // Nếu có sẵn huyện -> load xã
            if (selectedHuyen) {
                var huyenCode = $("#huyen option:selected").data("code");
                loadXa(huyenCode);
            }

            // Tự động tính phí khi load xong
            if (autoTinhPhi) {
                updatePhiVanChuyen();
            }
        });
    }

    function loadXa(huyenCode) {
        $.get("https://provinces.open-api.vn/api/d/" + huyenCode + "?depth=2", function (data) {
            data.wards.forEach(function (xa) {
                var selected = (xa.name === selectedXa) ? "selected" : "";
                $("#xa").append('<option value="' + xa.name + '" ' + selected + '>' + xa.name + '</option>');
            });
        });
    }

    // Tính phí vận chuyển
    function updatePhiVanChuyen() {
        var tinh = $("#tinh").val();
        if (!tinh) return; // nếu chưa có tỉnh thì không tính
        var tienHang = @TienHang; // lấy giá trị TienHang từ Razor
        $.post("/GioHangs/CapNhatPhiVanChuyen", { tinh: tinh, tienHang: tienHang }, function (data) {
            $("#phiVanChuyen").text(data.phiVanChuyen.toLocaleString());
            $("#tongTien").text(data.tongTien.toLocaleString());
        });
    }
});

</script>
