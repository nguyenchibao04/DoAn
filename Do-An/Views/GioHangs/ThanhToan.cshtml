
@model IEnumerable<WebApplication17.Models.GioHang>
@{
    ViewBag.Title = "Thanh Toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
    decimal TienHang = 0;
    decimal PhiVanChuyen = 0;
    var kh = ViewBag.taikhoan as WebApplication17.Models.KhachHang;
}

<main class="main">
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="~/Home/Index">Trang Chủ</a></li>
                <li class="breadcrumb-item"><a href="~/SanPhams">Sản Phẩm</a></li>
                <li class="breadcrumb-item active" aria-current="page">Thanh Toán</li>
            </ol>
        </div>
    </nav>

    <div class="page-content">
        <div class="checkout">
            <div class="container">
                <form action="/GioHangs/DatHang" method="post" id="formThanhToan">
                    <div class="row">
                        <div class="col-lg-7">
                            <h2 class="checkout-title">Chi Tiết Thanh Toán</h2>
                            <label>Họ Tên *</label>
                            <input type="text" class="form-control" name="hoten" value="@kh.hoten" required>

                            <label>Email *</label>
                            <input type="email" class="form-control" name="email" value="@kh.email" required>

                            <div class="row">
                                <div class="col-sm-6">
                                    <label>Tỉnh / Thành Phố *</label>
                                    <select class="form-control" id="tinh" name="tinh"></select>
                                </div>
                                <div class="col-sm-6">
                                    <label>Quận / Huyện *</label>
                                    <input type="text" class="form-control" name="huyen" value="@kh.huyen" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-6">
                                    <label>Phường / Xã *</label>
                                    <input type="text" class="form-control" name="phuongxa" value="@kh.xa" required>
                                </div>
                                <div class="col-sm-6">
                                    <label>Điện Thoại *</label>
                                    <input type="tel" class="form-control" name="dienthoai" value="@kh.dienthoai" required>
                                </div>
                            </div>

                            <label>Địa Chỉ Cụ Thể</label>
                            <input type="text" class="form-control" name="diachi" value="@kh.diachi" required>
                        </div>

                        <aside class="col-lg-5">
                            <div class="summary">
                                <h3 class="summary-title">Sản Phẩm Mua</h3>
                                <table class="table table-summary">
                                    <thead>
                                        <tr>
                                            <th>Tên Sản Phẩm</th>
                                            <th>Thành Tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model != null && Model.Any())
                                        {
                                            foreach (var item in Model.Where(x => x.giaban != null && x.giaban > 0))
                                            {
                                                decimal gia = (item.giaban ?? 0) * item.soluong;
                                                TienHang += gia;
                                                <tr>
                                                    <td>@item.SanPham.tensp (@item.CauHinhThem)</td>
                                                    <td>@gia.ToString("N0")</td>
                                                </tr>
                                            }
                                        }
                                        <tr>
                                            <td><b>Phí Vận Chuyển:</b></td>
                                            <td id="phiVanChuyen">@PhiVanChuyen.ToString("N0")</td>
                                        </tr>
                                        <tr class="summary-total">
                                            <td>Tổng:</td>
                                            <td id="tongTien">@((TienHang + PhiVanChuyen).ToString("N0"))</td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div class="accordion-summary" id="accordion-payment">
                                    <div class="card">
                                        <div class="card-header">
                                            <input type="radio" name="thanhtoan" value="cod" checked> Thanh Toán Khi Nhận Hàng <br>
                                            <input type="radio" name="thanhtoan" value="banking"> Thanh Toán Chuyển Khoản (VNPay)
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-outline-primary-2 btn-order btn-block mt-2">
                                    <span class="btn-text">ĐẶT HÀNG</span>
                                </button>
                            </div>
                        </aside>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<script src="~/Scripts/jquery-3.7.0.min.js"></script>
<script>
    $(document).ready(function(){
        // Load danh sách tỉnh/thành phố từ JSON
        $.getJSON('/Content/diachi.json', function(data){
            var select = $("#tinh");
            select.empty();
            $.each(data.tinh, function(index, item){
                var selected = "@kh.tinh" === item ? "selected" : "";
                select.append('<option value="'+item+'" '+selected+'>'+item+'</option>');
            });
            // Tính phí vận chuyển khi load page
            updatePhiVanChuyen();
        });

        // Khi chọn tỉnh/thành phố, tự động cập nhật phí vận chuyển và tổng tiền
        $("#tinh").change(function(){
            updatePhiVanChuyen();
        });

        function updatePhiVanChuyen(){
            var tinh = $("#tinh").val();
            $.post("/GioHangs/CapNhatPhiVanChuyen", { tinh: tinh }, function(data){
                $("#phiVanChuyen").text(data.phiVanChuyen);
                $("#tongTien").text(data.tongTien);
            });
        }
    });
</script>